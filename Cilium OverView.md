

### 1. Cilium, 왜 갑자기 '대세'가 되었을까? (feat. eBPF)

쿠버네티스를 사용하다 보면 CNI(Container Network Interface)는 필수적으로 선택해야 합니다. Flannel, Calico 등 여러 훌륭한 CNI가 있지만, 최근 Cilium이 압도적인 주목을 받는 이유는 바로 **eBPF(extended Berkeley Packet Filter)** 라는 리눅스 커널 기술을 핵심으로 사용하기 때문입니다.

### 기존 `iptables` 방식의 한계

기존 CNI들은 대부분 리눅스의 `iptables`를 사용하여 네트워크 라우팅과 정책을 구현했습니다. `iptables`는 매우 강력하지만, 다음과 같은 한계점을 가지고 있었습니다.

  * **성능 저하:** 파드와 서비스가 수천 개로 늘어나면 `iptables` 규칙 체인이 매우 길고 복잡해집니다. 모든 네트워크 패킷이 이 긴 체인을 순차적으로 검사해야 하므로, 병목 현상이 발생하고 성능이 저하됩니다.
  * **복잡성:** `iptables` 규칙은 추적하고 디버깅하기가 매우 어렵습니다.
  * **동적 환경의 어려움:** 파드가 생성되고 삭제될 때마다 `iptables` 규칙을 업데이트하는 것은 상당한 오버헤드를 유발합니다.

#### eBPF: 커널의 슈퍼파워

eBPF는 이러한 문제에 대한 혁신적인 해답을 제시합니다. eBPF는 **리눅스 커널의 코드를 직접 변경하지 않고도, 샌드박스 환경에서 특정 코드를 실행**할 수 있게 해주는 혁명적인 기술입니다.

Cilium은 이 eBPF를 활용하여 네트워크 패킷이 커널에 들어오는 시점(`XDP`, `TC hook`)에서 직접 처리합니다.



**Cilium이 eBPF로 얻는 이점:**

1.  **압도적인 성능:** 패킷이 `iptables`와 같은 복잡한 경로를 거치지 않고 커널 레벨에서 즉시 처리됩니다. 이는 낮은 지연 시간과 높은 처리량을 보장합니다.
2.  **Kube-proxy 완전 대체:** Cilium은 eBPF를 사용하여 쿠버네티스 서비스의 로드 밸런싱까지 직접 처리합니다. 더 이상 `kube-proxy`가 필요 없어져 클러스터가 더 단순해지고 빨라집니다.
3.  **강력한 보안:** IP 주소가 아닌, **ID(Identity) 기반**의 보안 정책을 L3/L4는 물론 L7(API 레벨)까지 적용할 수 있습니다.

-----

### 2. Cilium의 핵심 기능 파헤치기

Cilium은 단순한 CNI를 넘어, 네트워킹, 보안, 관찰 가능성을 모두 아우르는 올인원 솔루션입니다.

#### **1) ID 기반 보안 정책: IP는 잊어라\!**

클라우드 네이티브 환경에서 파드의 IP는 언제든 바뀔 수 있습니다. 기존의 IP 기반 방화벽 규칙은 이런 환경에 적합하지 않습니다.

Cilium은 쿠버네티스의 \*\*레이블(Label)\*\*을 파드의 'ID'로 사용합니다. 예를 들어, 다음과 같이 직관적인 정책을 만들 수 있습니다.

> " `app: backend` 레이블을 가진 파드는 `app: database` 레이블을 가진 파드의 TCP 3306 포트로만 통신할 수 있다."

**CiliumNetworkPolicy 예시:**

```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "backend-to-db"
spec:
  endpointSelector:
    matchLabels:
      app: database # 이 정책은 'database' 파드에 적용됩니다.
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: backend # 'backend' 파드로부터의 접근만 허용합니다.
    toPorts:
    - ports:
      - port: "3306"
        protocol: TCP
```

심지어 **L7 API 레벨 정책**도 가능합니다.

> "`role: user` 파드는 `HTTP GET /api/v1/data`는 호출할 수 있지만, `HTTP POST /api/v1/admin`은 호출할 수 없다."

이는 마이크로서비스 아키텍처에서 Zero Trust 보안을 구현하는 강력한 기반이 됩니다.

#### **2) Hubble: 실시간 네트워크 관찰의 끝판왕 **

"내 파드는 왜 저 서비스와 통신이 안 되지?"
"어떤 서비스가 갑자기 네트워크 트래픽을 많이 유발하지?"

이런 질문에 답하기 위해 로그를 뒤지고 `tcpdump`를 실행하던 시대는 지났습니다. Cilium의 관찰 가능성 플랫폼 **Hubble**이 있기 때문입니다.

  * **서비스 맵:** 클러스터 내의 모든 서비스 통신을 실시간으로 시각화하여 서비스 간의 의존성을 한눈에 파악할 수 있습니다.
  * **실시간 흐름 모니터링:** 어떤 파드에서 어떤 파드로, 어떤 포트를 통해 통신이 일어나는지, 그리고 해당 통신이 네트워크 정책에 의해 허용되었는지, 거부되었는지를 즉시 확인할 수 있습니다.
  * **L7 가시성:** HTTP 경로, gRPC 호출, DNS 쿼리 등 애플리케이션 레벨의 통신 내용까지 들여다볼 수 있어 디버깅이 매우 쉬워집니다.


Hubble은 UI, CLI, Metrics API를 제공하여 어떤 환경에서도 유연하게 네트워크를 관찰하고 분석할 수 있도록 지원합니다.

#### **3) 서비스 메시(Service Mesh): Istio 없이 더 가볍게**

서비스 메시는 마이크로서비스 간의 통신을 제어, 보호, 모니터링하는 기술입니다. Istio가 대표적이지만, 모든 파드에 `Envoy` 프록시 사이드카를 주입해야 해서 리소스 오버헤드와 운영 복잡성이 상당했습니다.

Cilium은 eBPF를 활용하여 **사이드카 없는(Sidecar-less)** 서비스 메시를 구현합니다.

  * **Cilium Ambient Service Mesh:** Istio와 유사하게 노드 레벨의 프록시(ztunnel)와 필요시 L7 처리를 위한 프록시(waypoint)를 두는 아키텍처를 채택했습니다. 하지만 eBPF를 통해 트래픽을 리다이렉션하므로 훨씬 효율적입니다.
  * **장점:**
      * **리소스 절약:** 파드마다 사이드카가 없으므로 CPU와 메모리 사용량이 크게 줄어듭니다.
      * **운영 간소화:** 사이드카 주입 및 관리에 신경 쓸 필요가 없습니다.
      * **성능 향상:** 커널 레벨에서 트래픽을 처리하여 지연 시간이 짧습니다.

TLS 암호화(mTLS), Canary 배포, 트래픽 분할, L7 로드 밸런싱 등 Istio가 제공하는 대부분의 기능을 더 낮은 비용으로 사용할 수 있게 됩니다.

